ä»é›¶æ„å»º Dispatch Queue

> ä½œè€…ï¼šMike Ashï¼Œ[åŸæ–‡é“¾æ¥](https://www.mikeash.com/pyblog/friday-qa-2015-09-04-lets-build-dispatch_queue.html)ï¼ŒåŸæ–‡æ—¥æœŸï¼š2015-09-04
> è¯‘è€…ï¼š[æ™ºå¤šèŠ¯](http://hulizhen.me)ï¼›æ ¡å¯¹ï¼š[Crystal Sun](http://www.jianshu.com/users/7a2d2cc38444/latest_articles)ï¼›å®šç¨¿ï¼š[CMB](https://github.com/chenmingbiao)
  









Grand Central Dispatch æ˜¯ Apple å…¬å¸æœ€è¿‘å‡ å¹´æ¨å‡ºçš„é‡é‡çº§ API ä¹‹ä¸€ã€‚åœ¨æœ¬æ¬¡â€œä»é›¶æ„å»ºâ€ç³»åˆ—æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ¢ç´¢ä¸€ä¸ªç”± Rob Rix å»ºè®®çš„ä¸»é¢˜ï¼šä»é›¶æ„å»ºä¸€ä¸ªå…·å¤‡åŸºæœ¬åŠŸèƒ½çš„ Dispatch Queueã€‚



### æ¦‚è¿°

åˆ†å‘é˜Ÿåˆ—ï¼ˆDispatch Queueï¼‰æ˜¯ä¸€ä¸ªä¿å­˜äº†å¤šä¸ªåŸºäºå…¨å±€çº¿ç¨‹æ± çš„ä»»åŠ¡ï¼ˆè¯‘è€…æ³¨ï¼šå…¶å®å°±æ˜¯ä¸€ç³»åˆ—çš„ä»£ç å—ï¼‰çš„é˜Ÿåˆ—ã€‚æäº¤åˆ°é˜Ÿåˆ—çš„ä»»åŠ¡é€šå¸¸ä¼šè¢«æ”¾åˆ°ä¸€ä¸ªåå°çº¿ç¨‹å¼‚æ­¥æ‰§è¡Œã€‚ä¸ºäº†ä½¿æ•´ä¸ªç³»ç»Ÿè¿ä½œå¾—æ›´é«˜æ•ˆï¼Œæ‰€æœ‰çš„çº¿ç¨‹å…±äº«ä¸€ä¸ªåå°çº¿ç¨‹æ± ã€‚

è¿™å°±æ˜¯ä¸‹é¢å°†è¦å®ç°çš„ API æ ¸å¿ƒåŠŸèƒ½ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œæœ¬æ–‡ä¼šç•¥å»å¾ˆå¤š GCD æä¾›çš„é¢å¤–åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œå…¨å±€çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡ä¼šéšç€ä»»åŠ¡æ€»é‡å’Œç³»ç»Ÿçš„ CPU ä½¿ç”¨ç‡è¿›è¡ŒåŠ¨æ€è°ƒæ•´ã€‚åœ¨å·²æœ‰ä¸€å †è€— CPU çš„ä»»åŠ¡åœ¨è¿è¡Œçš„æƒ…å½¢ä¸‹ï¼Œå¦‚æœæ­¤æ—¶å†æäº¤ä¸€ä¸ªä»»åŠ¡ï¼ŒGCD ä¸ä¼šå†ä¸ºè¯¥ä»»åŠ¡åˆ›å»ºæ–°çš„çº¿ç¨‹ã€‚å› ä¸ºæ­¤æ—¶ CPU å·²ç»æ»¡è´Ÿè·è¿è¡Œäº†ï¼Œå†åˆ›å»ºæ–°çš„çº¿ç¨‹åªä¼šå¯¼è‡´ç³»ç»Ÿæ›´ä½æ•ˆã€‚ä¸‹é¢æˆ‘ä¼šç›´æ¥å°†çº¿ç¨‹æ•°é‡ç¡¬ç¼–ç åœ¨ä»£ç ä¸­ã€‚åŒæ ·ï¼Œå…¶ä»–çš„é¢å¤–åŠŸèƒ½ï¼Œå¦‚ç›®æ ‡é˜Ÿåˆ—å’Œå¹¶è¡Œé˜Ÿåˆ—å±éšœï¼Œä¹Ÿä¼šä¸€å¹¶ç•¥è¿‡ã€‚

æœ¬æ–‡ä¼šæŠŠé‡ç‚¹æ”¾åœ¨å®ç°åˆ†å‘é˜Ÿåˆ—çš„æ ¸å¿ƒåŠŸèƒ½ä¸Šï¼šåŸºäºä¸€ä¸ªå…±äº«çš„å…¨å±€çº¿ç¨‹æ± å®ç°ä¸²è¡Œ/å¹¶è¡ŒåŠåŒæ­¥/å¼‚æ­¥æ´¾å‘ä»»åŠ¡ã€‚

### ä»£ç 

å’Œå¾€å¸¸ä¸€æ ·ï¼Œæœ¬æ–‡ä¸­çš„ä»£ç å¯åœ¨ GitHub ä¸Šè·å–ï¼š

https://github.com/mikeash/MADispatchQueue

å¯ä»¥è¾¹è¯»æœ¬æ–‡è¾¹æ•²ä»£ç ï¼Œä¹Ÿå¯ä»¥è‡ªå·±æ¢ç´¢ã€‚

### æ¥å£

GCD æä¾›çš„æ˜¯ä¸€ç³»åˆ—çš„ C è¯­è¨€ APIã€‚è™½ç„¶åœ¨æœ€è¿‘å‘å¸ƒçš„ OS ä¸Š Apple å·²ç»å°† GCD å¯¹è±¡è½¬æˆäº† Objective-C å¯¹è±¡ï¼Œä½† API è¿˜æ˜¯ä¿æŒç€çº¯ C è¯­è¨€æ¥å£ï¼ˆè¿˜æ–°å¢äº†å¯¹ Block æ”¯æŒï¼‰ã€‚è¿™å¯¹åº•å±‚ API æ¥è¯´å…¶å®æ˜¯å¥½äº‹ï¼Œæä¾›çš„æ¥å£ä¹Ÿååˆ†ç®€æ´ã€‚ä½†æœ¬æ–‡å°†é‡‡ç”¨ Objective-C è¯­è¨€æ¥å®ç°ã€‚

æœ¬æ–‡å®ç°çš„ Objective-C ç±»å«åš `MADispatchQueue`ï¼Œå®ƒåªæä¾›äº†å››ä¸ªæ–¹æ³•ï¼š

1. ä¸€ä¸ªè·å–å…±äº«çš„å…¨å±€é˜Ÿåˆ—çš„æ–¹æ³•ã€‚GCD æœ‰å¤šä¸ªä¸åŒä¼˜å…ˆçº§çš„å…¨å±€é˜Ÿåˆ—ï¼Œä½†ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬åªæœ‰ä¸€ä¸ªå…¨å±€é˜Ÿåˆ—ã€‚
2. ä¸€ä¸ªæ„é€ å™¨ï¼Œå¯é€šè¿‡å®ƒåˆ›å»ºå¹¶è¡Œæˆ–ä¸²è¡Œé˜Ÿåˆ—ã€‚
3. ä¸€ä¸ªå¼‚æ­¥æ´¾å‘æ–¹æ³•ã€‚
4. ä¸€ä¸ªåŒæ­¥æ´¾å‘æ–¹æ³•ã€‚

æ¥å£çš„å£°æ˜å¦‚ä¸‹ï¼š

    objective-c
    @interface MADispatchQueue : NSObject
    
    + (MADispatchQueue *)globalQueue;
    
    - (id)initSerial: (BOOL)serial;
    
    - (void)dispatchAsync: (dispatch_block_t)block;
    - (void)dispatchSync: (dispatch_block_t)block;
    
    @end

æœ¬æ–‡çš„ç›®æ ‡å°±æ˜¯å®ç°è¿™äº›æ–¹æ³•çš„åŠŸèƒ½ã€‚

### çº¿ç¨‹æ± æ¥å£

ç”¨æ¥æ”¯æ’‘åˆ†å‘é˜Ÿåˆ—çš„çº¿ç¨‹æ± æœ‰ç€ç›¸å¯¹ç®€æ´çš„æ¥å£ï¼Œè¯¥çº¿ç¨‹æ± è´Ÿè´£æ‰§è¡Œè¢«æäº¤çš„ä½œä¸šã€‚åˆ†å‘é˜Ÿåˆ—è´Ÿè´£åœ¨åˆé€‚çš„æ—¶æœºå°†å·²å…¥é˜Ÿçš„ä½œä¸šæäº¤åˆ°çº¿ç¨‹æ± ã€‚

çº¿ç¨‹æ± åªæœ‰ä¸€ä¸ªç®€å•çš„ä»»åŠ¡ï¼šæäº¤ä½œä¸šå¹¶æ‰§è¡Œã€‚å› æ­¤ï¼Œå®ƒå°±åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼š

    objective-c
    @interface MAThreadPool : NSObject
    
    - (void)addBlock: (dispatch_block_t)block;
    
    @end

å› ä¸ºè¿™æ˜¯æ•´ä¸ªçº¿ç¨‹æ± çš„æ ¸å¿ƒï¼Œæ‰€ä»¥æ¥ä¸‹æ¥å…ˆæŠŠå®ƒå®ç°äº†ã€‚

### çº¿ç¨‹æ± å®ç°

é¦–å…ˆçœ‹ä¸‹å®ä¾‹å˜é‡ã€‚çº¿ç¨‹æ± å¯èƒ½ä¼šè¢«å¤–éƒ¨æˆ–å†…éƒ¨çš„å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ï¼Œå› æ­¤å¿…é¡»ä¿è¯å…¶çº¿ç¨‹å®‰å…¨ã€‚è™½ç„¶ GCD å°½å¯èƒ½åœ°ä½¿ç”¨äº†å¿«é€ŸåŸå­æ“ä½œä»¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä½†æœ¬æ–‡è¿˜æ˜¯é‡‡ç”¨å¤è€çš„é”æ–¹æ¡ˆã€‚é™¤äº†ä¿è¯è¯»å†™æ“ä½œäº’æ–¥å¤–ï¼Œè¯¥é”è¿˜è¦æ”¯æŒ `wait` å’Œ `signal` æ“ä½œï¼Œå› æ­¤ä½¿ç”¨äº† `NSCondition`ï¼Œè€Œä¸æ˜¯åŸç”Ÿçš„ `NSLock`ã€‚å¦‚æœä½ ä¸ç†Ÿæ‚‰ `NSCondition` ä¹Ÿæ²¡å…³ç³»ï¼Œå®é™…ä¸Šå®ƒåªæ˜¯æŠŠé”å’Œä¸€ä¸ªæ¡ä»¶å˜é‡å°è£…åœ¨ä¸€èµ·è€Œå·²ï¼š

    objective-c
    NSCondition *_lock;

ä¸ºäº†ç¡®å®šä½•æ—¶å¯åŠ¨æ–°çš„çº¿ç¨‹ï¼Œéœ€è¦çŸ¥é“å½“å‰çº¿ç¨‹æ± ä¸­æœ‰å¤šå°‘çº¿ç¨‹ï¼Œæœ‰å¤šå°‘çº¿ç¨‹æ­£åœ¨è¿è¡Œï¼Œçº¿ç¨‹æ± æœ€å¤šæ”¯æŒå¤šå°‘çº¿ç¨‹ï¼š

    objective-c
    NSUInteger _threadCount;
    NSUInteger _activeThreadCount;
    NSUInteger _threadCountLimit;

æœ€åæ˜¯ä¸€ä¸ªä¿å­˜äº†å¤šä¸ªä»£ç å—çš„æ•°ç»„ã€‚è¿™é‡Œä½¿ç”¨äº† `NSMutableArray` æ¥å®ç°é˜Ÿåˆ—ï¼Œé€šè¿‡è¿½åŠ æ–°çš„ä»£ç å—åˆ°æœ«å°¾æ¥å®ç°å…¥é˜Ÿæ“ä½œï¼Œé€šè¿‡åˆ é™¤å¼€å¤´çš„ä»£ç å—æ¥å®ç°å‡ºé˜Ÿæ“ä½œã€‚

    objective-c
    NSMutableArray *_blocks;

åˆå§‹åŒ–æ–¹æ³•å¾ˆç®€å•ï¼Œåªæ˜¯åˆå§‹åŒ–é”ã€ä»£ç å—æ•°ç»„ï¼Œæœ€åå°†çº¿ç¨‹æ•°çš„æœ€å¤§å€¼è®¾ç½®æˆ 123ï¼ˆéšæœºé€‰æ‹©çš„æ•°ç›®ï¼‰ï¼š

    objective-c
    - (id)init {
        if((self = [super init])) {
            _lock = [[NSCondition alloc] init];
            _blocks = [[NSMutableArray alloc] init];
            _threadCountLimit = 128;
        }
        return self;
    }

å·¥ä½œçº¿ç¨‹ä¸­ä¸»è¦æ˜¯ä¸€ä¸ªæ— é™å¾ªç¯ã€‚å½“ä»£ç å—æ•°ç»„ä¸ºç©ºæ—¶ï¼Œçº¿ç¨‹è¿›å…¥ä¼‘çœ å¹¶ç­‰å¾…ã€‚ä¸€æ—¦æ•°ç»„ä¸ä¸ºç©ºï¼Œè¯¥ä»£ç å—ç«‹å³å‡ºé˜Ÿå¹¶å¼€å§‹æ‰§è¡Œã€‚ä»£ç å—æ‰§è¡Œå¼€å§‹åï¼Œå½“å‰æ´»è·ƒçº¿ç¨‹æ•°åŠ ä¸€ï¼›ä»£ç å—æ‰§è¡Œå®Œæˆåï¼Œå½“å‰æ´»è·ƒçº¿ç¨‹æ•°å‡ä¸€ï¼š

    objective-c
    - (void)workerThreadLoop: (id)ignore {

åœ¨è¿›å…¥å¾ªç¯ä¹‹å‰å…ˆåŠ é”ï¼Œè‡³äºä¸ºä»€ä¹ˆè¿™ä¹ˆåšï¼Œè¯·ç»§ç»­å¾€ä¸‹çœ‹ï¼š

    objective-c
    	[_lock lock];

æ¥ç€è¿›å…¥æ— é™å¾ªç¯ï¼š

    objective-c
    	while (1) {

å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™ç­‰å¾…ï¼š

    objective-c
        	while ([_blocks count] == 0) {
            	[_lock wait];
        	}

è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œä¸Šé¢ä»£ç æ˜¯åœ¨ä¸€ä¸ªå¾ªç¯ä¸­ï¼Œè€Œä¸ä»…ä»…åªæ˜¯ä¸€ä¸ª `if` è¯­å¥ã€‚è¿™ä¹ˆåšæ˜¯å› ä¸º[å‡æ€§å”¤é†’](https://en.wikipedia.org/wiki/Spurious_wakeup)ã€‚ç®€å•åœ°è¯´ï¼Œå³ä½¿æ²¡æœ‰å‘é€`signal`ä¿¡å·ï¼Œ`wait` ä¹Ÿå¯èƒ½æå‰è¿”å›ã€‚ä¸ºäº†è®©ä»£ç äº§ç”Ÿé¢„æœŸçš„è¡Œä¸ºï¼Œ`wait` è¿”å›æ—¶æ¯æ¬¡éƒ½è¦æ£€æŸ¥ä»£ç å—çš„æ•°é‡ã€‚

ä¸€æ—¦æœ‰äº†å¯ç”¨ä»£ç å—ï¼Œç«‹å³å‡ºé˜Ÿï¼š

    objective-c
        	dispatch_block_t block = [_blocks firstObject];
        	[_blocks removeObjectAtIndex: 0];

å°†å½“å‰æ´»è·ƒçº¿ç¨‹æ•°åŠ ä¸€ï¼Œè¡¨æ˜å½“å‰çº¿ç¨‹æ­£å¿™ï¼š

    objective-c
    		_activeThreadCount++;

ç°åœ¨æ˜¯æ—¶å€™å¼€å§‹æ‰§è¡Œä»£ç å—äº†ã€‚ä½†åœ¨æ­¤ä¹‹å‰éœ€è¦å…ˆè§£é”ï¼Œå¦åˆ™å°±æ— æ³•å¹¶å‘æ‰§è¡Œä»£ç ï¼Œå¹¶ä¸”æ‰€æœ‰è¯•å›¾å¯¹è¯¥é”åŠ é”çš„çº¿ç¨‹éƒ½ä¼šå¯¼è‡´æ­»é”ï¼š

    objective-c
            [_lock unlock];

å®‰å…¨åœ°è§£é”å¹¶ç«‹å³æ‰§è¡Œä»£ç å—ï¼š

    objective-c
    		block();

å½“è¯¥ä»£ç å—æ‰§è¡Œå®Œåï¼Œå°†å½“å‰æ´»è·ƒçº¿ç¨‹æ•°å‡ä¸€ã€‚åœ¨è¿™æ ·åšä¹‹å‰éœ€è¦å…ˆåŠ é”ä»¥é¿å…ç«äº‰æ¡ä»¶ã€‚åˆ°è¿™é‡Œå¾ªç¯ä¹Ÿå°±ç»“æŸäº†ï¼š

    objective-c
            [_lock lock];
            _activeThreadCount--;
        }
    }

ç°åœ¨åº”è¯¥æ˜ç™½ä¸ºä»€ä¹ˆè¿›å…¥ä¸Šé¢è¿™ä¸ªå¾ªç¯ä¹‹å‰å…ˆåŠ é”äº†ã€‚å¾ªç¯ä¸­çš„æœ€åä¸€æ­¥æ˜¯å°†å½“å‰æ´»è·ƒçº¿ç¨‹æ•°å‡ä¸€ï¼Œè¿›å…¥å¾ªç¯çš„ç¬¬ä¸€æ­¥æ˜¯æ£€æŸ¥é˜Ÿåˆ—ä¸­çš„ä»£ç å—æ•°é‡ï¼Œè€Œè¿™ä¸¤ä¸ªæ“ä½œéƒ½éœ€è¦å…ˆåŠ é”ã€‚é€šè¿‡åœ¨å¾ªç¯å¤–åŠ é”ï¼Œåç»­çš„è¿­ä»£åªéœ€è¦åŠ ä¸€æ¬¡é”å³å¯ã€‚è€Œä¸éœ€è¦åŠ é”ã€è§£é”ï¼Œåˆé©¬ä¸ŠåŠ é”ã€‚

ç°åœ¨æ¥çœ‹çœ‹ `addBlock`ï¼š

    objective-c
    - (void)addBlock: (dispatch_block_t)block {

è¿™ä¸ªæ–¹æ³•ä¸­çš„æ‰€æœ‰æ“ä½œéƒ½éœ€è¦åŠ é”ï¼š

    objective-c
    	[_lock lock];

ç¬¬ä¸€ä»¶äº‹å°±æ˜¯å°†ä¼ å…¥çš„ä»£ç å—æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼š

    objective-c
        [_blocks addObject: block];

å¦‚æœç›®å‰æœ‰ç©ºé—²çš„å·¥ä½œçº¿ç¨‹å¯ä»¥æ‰§è¡Œè¯¥ä»£ç å—ï¼Œé‚£ä¹ˆå°±æ²¡ä»€ä¹ˆéœ€è¦åšçš„äº†ã€‚å¦‚æœæ²¡æœ‰ç©ºé—²çº¿ç¨‹å»å¤„ç†è¿™ä¸ªè¿˜æœªè¢«æ‰§è¡Œçš„ä»£ç å—ï¼Œå¹¶ä¸”å·¥ä½œçº¿ç¨‹æ€»æ•°è¿˜æ²¡è¶…å‡ºé™åˆ¶ï¼Œé‚£å°±æ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼š

    objective-c
    	NSUInteger idleThreads = _threadCount - _activeThreadCount;
        if([_blocks count] > idleThreads && _threadCount < _threadCountLimit) {
        	[NSThread detachNewThreadSelector: @selector(workerThreadLoop:)
                                     toTarget: self
                                   withObject: nil];
            _threadCount++;
        }

ç°åœ¨æœ‰äº†ç©ºé—²çš„å·¥ä½œçº¿ç¨‹å¯ä»¥æ‰§è¡Œä»£ç å—äº†ã€‚ä½† `workerThreadLoop` ä¸­çš„å¾ªç¯å¯èƒ½ç”±äº `wait` æ“ä½œè€Œå¤„äºä¼‘çœ çŠ¶æ€ï¼Œå› æ­¤æ‰§è¡Œä¸€ä¸‹ `signal` æ“ä½œå”¤é†’å®ƒï¼š

    objective-c
    	[_lock signal];

æœ€åè§£é”ï¼š

    objective-c
        [_lock unlock];
    }

ä¸Šé¢å®ç°çš„çº¿ç¨‹æ± èƒ½å¤Ÿåˆ›å»ºé¢„å®šæ•°ç›®çš„å·¥ä½œçº¿ç¨‹ä»¥ä¾¿æ‰§è¡Œæ–°å…¥é˜Ÿçš„ä»£ç å—ã€‚æ¥ä¸‹æ¥å°±åˆ©ç”¨è¿™ä¸ªçº¿ç¨‹æ± å»å®ç°åˆ†å‘é˜Ÿåˆ— `Dispatch Queue`ã€‚

### åˆ†å‘é˜Ÿåˆ—çš„å®ç°

å’Œçº¿ç¨‹æ± ç›¸åŒçš„æ˜¯ï¼Œåˆ†å‘é˜Ÿåˆ—åŒæ ·éœ€è¦ä¸€ä¸ªé”ã€‚è€Œä¸åŒçš„æ˜¯ï¼Œå®ƒå¹¶ä¸éœ€è¦ `wait` å’Œ `signal`æ“ä½œï¼Œåªéœ€è¦æœ€åŸºæœ¬çš„äº’æ–¥é” `NSLock`ï¼š

    objective-c
    NSLock *_lock;

ç±»ä¼¼çº¿ç¨‹æ± ï¼Œåˆ†å‘é˜Ÿåˆ—ä½¿ç”¨ `NSMutableArray` ç»´æŠ¤äº†ä¸€ä¸ªé˜Ÿåˆ—ç”¨äºä¿å­˜è¿˜æœªè¢«æ‰§è¡Œçš„ä»£ç å—ï¼š

    objective-c
    NSMutableArray *_pendingBlocks;

`Dispatch Queue` éœ€è¦çŸ¥é“è‡ªå·±æ˜¯ä¸²è¡Œè¿˜æ˜¯å¹¶è¡Œé˜Ÿåˆ—ã€‚

    objective-c
    BOOL _serial;

å¦‚æœæ˜¯ä¸²è¡Œé˜Ÿåˆ—ï¼Œå®ƒè¿˜éœ€è¦è·Ÿè¸ªçº¿ç¨‹æ± ä¸­æ˜¯å¦æœ‰ä»£ç å—æ­£åœ¨æ‰§è¡Œï¼š

    objective-c
    BOOL _serialRunning;

å¹¶è¡Œé˜Ÿåˆ—åˆ™ä¸ç®¡æ˜¯å¦æœ‰ä»£ç å—æ­£åœ¨è¿è¡Œéƒ½ä¸å½±å“ï¼Œå› æ­¤ä¸éœ€è¦è·Ÿè¸ªè¯¥çŠ¶æ€ã€‚

å’Œå…±äº«çš„çº¿ç¨‹æ± ä¸€æ ·ï¼Œå°†å…¨å±€é˜Ÿåˆ—ä¿å­˜åœ¨ä¸€ä¸ªå…¨å±€å˜é‡ä¸­ï¼ŒäºŒè€…éƒ½åœ¨ `+initialize` æ–¹æ³•ä¸­åˆ›å»ºï¼š

    objective-c
    static MADispatchQueue *gGlobalQueue;
    static MAThreadPool *gThreadPool;
    
    + (void)initialize {
        if(self == [MADispatchQueue class]) {
            gGlobalQueue = [[MADispatchQueue alloc] initSerial: NO];
            gThreadPool = [[MAThreadPool alloc] init];
        }
    }

`+initialize` æ–¹æ³•å·²ç»ç¡®ä¿äº†å…¨å±€é˜Ÿåˆ—ä¼šè¢«åˆ›å»ºï¼Œå› æ­¤ `+globalQueue` æ–¹æ³•å¯ç›´æ¥è¿”å› `gGlobalQueue`ï¼š

    objective-c
    + (MADispatchQueue *)globalQueue {
        return gGlobalQueue;
    }

è¿™é‡Œæœ¬æ¥æ˜¯å¯ä»¥ç›´æ¥ç”¨ `dispatch_once` æ–¹æ³•çš„ï¼Œä½†è¿™ä¹ˆåšä¼šæœ‰ç§ä½¿ç”¨äº† GCD API æ¥ä½œå¼Šçš„æ„Ÿè§‰ï¼Œè¯´å¥½çš„è¦ä»é›¶æ„å»ºçš„ï¼Œè™½ç„¶è¿™å¹¶ä¸æ˜¯æˆ‘ä»¬è¦å®ç°çš„ APIã€‚

åˆå§‹åŒ–æ–¹æ³•åŒ…æ‹¬åˆ†é…é”ã€åˆ›å»ºä»£ç å—é˜Ÿåˆ—ï¼ˆè¯‘è€…æ³¨ï¼šè¿˜æœªè¢«æ‰§è¡Œçš„ä»£ç å—ï¼‰ï¼Œè¿˜è¦è®¾ç½® `_serial` å˜é‡ï¼š

    objective-c
    - (id)initSerial: (BOOL)serial {
        if ((self = [super init])) {
            _lock = [[NSLock alloc] init];
            _pendingBlocks = [[NSMutableArray alloc] init];
            _serial = serial;
        }
        return self;
    }

åœ¨è®²å…¶ä½™çš„å…¬å¼€ API ä¹‹å‰ï¼Œè¿˜æœ‰ä¸€ä¸ªåº•å±‚æ–¹æ³•éœ€è¦å®ç°ã€‚è¿™ä¸ªæ–¹æ³•ä¼šåœ¨çº¿ç¨‹æ± ä¸­å°† `_pendingBlocks` é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªä»£ç å—å–å‡ºå¹¶æ‰§è¡Œï¼Œæ¥ç€è¿˜å¾ˆæœ‰å¯èƒ½ï¼ˆä¸²è¡Œé˜Ÿåˆ—çš„æƒ…å†µä¸‹ï¼‰ä¼šè°ƒç”¨è‡ªèº«åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œå¦ä¸€ä¸ªä»£ç å—ï¼š

    objective-c
    - (void)dispatchOneBlock {

è¯¥æ–¹æ³•å”¯ä¸€çš„èŒè´£å°±æ˜¯åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œä»£ç å—ï¼Œæ‰€ä»¥æŠŠè‡ªèº«çš„åŠŸèƒ½ä»£ç å—æ·»åŠ åˆ°çº¿ç¨‹æ± ä¸­ï¼š

    objective-c
    	[gThreadPool addBlock: ^{

æ¥ç€ä»é˜Ÿåˆ—ä¸­å–å‡ºé˜Ÿåˆ—å¤´éƒ¨çš„ä»£ç å—ã€‚å½“ç„¶äº†ï¼Œè¿™ä¸ªæ“ä½œä¹Ÿéœ€è¦åŠ é”ï¼š

    objective-c
    		[_lock lock];
            dispatch_block_t block = [_pendingBlocks firstObject];
            [_pendingBlocks removeObjectAtIndex: 0];
            [_lock unlock];

åœ¨è§£é”åï¼Œä¸Šé¢å–å‡ºçš„ä»£ç å—å°±å¯ä»¥å®‰å…¨åœ°åœ¨åå°çº¿ç¨‹æ‰§è¡Œï¼ˆè¯‘è€…æ³¨ï¼šåœ¨å‰æ–‡çº¿ç¨‹æ± çš„å®ç°ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ¯ä¸ªæ·»åŠ åˆ°çº¿ç¨‹æ± ä¸­çš„ä»£ç å—éƒ½ä¼šåœ¨ç‹¬ç«‹çš„åå°çº¿ç¨‹ä¸­æ‰§è¡Œï¼‰ï¼š

    objective-c
    		block();

å¦‚æœé˜Ÿåˆ—æ˜¯å¹¶è¡Œçš„ï¼Œé‚£ä¹ˆåˆ°è¿™é‡Œå°±ç»“æŸäº†ã€‚å¦‚æœæ˜¯ä¸²è¡Œçš„è¯ï¼Œè¿˜éœ€è¦ä¸‹é¢çš„ä»£ç ï¼š

    objective-c
            if(_serial) {

åœ¨ä¸²è¡Œé˜Ÿåˆ—ä¸Šï¼Œæ–°å¢çš„ä»£ç å—éœ€è¦ç­‰åˆ°å‰ä¸€ä¸ªä»£ç å—æ‰§è¡Œå®Œåæ‰èƒ½æ‰§è¡Œã€‚æ¯å½“ä¸€ä¸ªä»£ç å—æ‰§è¡Œå®Œåï¼Œ`dispatchOneBlock` ä¼šæ£€æŸ¥å½“å‰é˜Ÿåˆ—æ˜¯å¦è¿˜æœ‰ä»£ç å—æœªæ‰§è¡Œã€‚å¦‚æœæœ‰çš„è¯ï¼Œå®ƒä¼šè°ƒç”¨è‡ªèº«ä»¥ä¾¿æœ€åå¯ä»¥æ‰§è¡Œåˆ°è¯¥ä»£ç å—ã€‚å¦‚æœæ²¡æœ‰ï¼Œå°†é˜Ÿåˆ—çš„è¿è¡ŒçŠ¶æ€è®¾ç½®å› `NO`ï¼š

    objective-c
                [_lock lock];
                if([_pendingBlocks count] > 0) {
                    [self dispatchOneBlock];
                } else {
                    _serialRunning = NO;
                }
                [_lock unlock];
            }
        }];
    }

æœ‰äº†ä¸Šé¢è¿™ä¸ªæ–¹æ³•ä¹‹åï¼Œå®ç° `dispatchAsync` å°±ç›¸å¯¹ç®€å•äº†ã€‚å°†ä»£ç å—æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œç„¶åæ ¹æ®æƒ…å†µï¼ˆæ˜¯å¦ä¸ºä¸²è¡Œé˜Ÿåˆ—ï¼‰è®¾ç½®é˜Ÿåˆ—çš„è¿è¡ŒçŠ¶æ€å¹¶è°ƒç”¨ `dispatchOneBlock`ï¼š

    objective-c
    - (void)dispatchAsync: (dispatch_block_t)block {
        [_lock lock];
        [_pendingBlocks addObject: block];

å¦‚æœæ˜¯ä¸²è¡Œé˜Ÿåˆ—ä¸”å½“å‰ç©ºé—²ï¼Œå°±å°†é˜Ÿåˆ—è¿è¡ŒçŠ¶æ€è®¾ç½®ä¸º `YES` å¹¶è°ƒç”¨ `dispatchOneBlock`ï¼š

    objective-c
        if(_serial && !_serialRunning) {
            _serialRunning = YES;
            [self dispatchOneBlock];

å¦‚æœæ˜¯å¹¶è¡Œé˜Ÿåˆ—ï¼Œå°±æ— æ¡ä»¶ç›´æ¥æ‰§è¡Œã€‚è¿™æ ·ä¿è¯äº†å³ä½¿å…¶ä»–ä»£ç å—æ­£åœ¨æ‰§è¡Œï¼Œæ–°å¢çš„ä»£ç å—ä¹Ÿèƒ½å°½å¿«æ‰§è¡Œï¼Œæ¯•ç«Ÿå¹¶è¡Œé˜Ÿåˆ—æ˜¯å…è®¸å¤šä¸ªä»£ç å—åŒæ—¶è¿è¡Œçš„ï¼š

    objective-c
    	} else if (!_serial) {
            [self dispatchOneBlock];
        }

å¦‚æœä¸²è¡Œé˜Ÿåˆ—å·²ç»åœ¨æ‰§è¡Œä»£ç å—äº†ï¼Œå°±æ²¡ä»€ä¹ˆéœ€è¦åšçš„äº†ï¼Œå·²ç»åœ¨æ‰§è¡Œçš„ `dispatchOneBlock`æœ€åä¼šæ‰§è¡Œåˆ°æ–°å¢çš„ä»£ç å—çš„ã€‚æœ€åè§£é”ï¼š

    objective-c
        [_lock unlock];
    }

æ¥ä¸‹æ¥è½®åˆ° `dispatchSync` äº†ã€‚ä¸ GCD çš„å®ç°ä¸åŒï¼Œæœ¬æ–‡ç›´æ¥ä½¿ç”¨ `dispatchAsync` æ´¾å‘ä»£ç å—ï¼Œå¹¶ç­‰åˆ°ä»£ç æ‰§è¡Œå®Œåå†è¿”å›ï¼ˆè¯‘è€…æ³¨ï¼šè¿™å°±æ˜¯åŒæ­¥çš„æ•ˆæœï¼‰ã€‚

ä¸ºäº†å®ç°è¿™ä¸ªç›®çš„ï¼Œè¿™é‡Œä½¿ç”¨åˆ°äº†ä¸€ä¸ªæœ¬åœ°æ¡ä»¶å˜é‡ `NSCondition`ï¼Œè¿˜æœ‰ä¸€ä¸ª `done` å˜é‡ç”¨äºè¡¨ç¤ºä»£ç å—æ˜¯å¦æ‰§è¡Œå®Œæ¯•ï¼š

    objective-c
     - (void)dispatchSync: (dispatch_block_t)block {
        NSCondition *condition = [[NSCondition alloc] init];
        __block BOOL done = NO;

æ¥ç€å¼‚æ­¥æ´¾å‘ä»£ç å—ã€‚è¿™é‡Œæ‰§è¡Œäº†é€šè¿‡å‡½æ•°å‚æ•°ä¼ è¿›æ¥çš„ä»£ç å—ï¼Œç„¶åè®¾ç½® `done` ä¸º `YES`å¹¶å”¤é†’ `condition`ï¼š

    objective-c
        [self dispatchAsync: ^{
            block();
            [condition lock];
            done = YES;
            [condition signal];
            [condition unlock];
        }];

åœ¨æ¡ä»¶å˜é‡ `condition` ä¸Šç­‰å¾… `done` è¢«è®¾ç½®æˆ `YES`ï¼Œç„¶åè¿”å›ï¼š

    objective-c
        [condition lock];
        while (!done) {
            [condition wait];
        }
        [condition unlock];
    }

åˆ°è¿™é‡Œå°±æˆåŠŸåœ°è¿è¡Œäº†ä»£ç å—ï¼Œè¿™ä¹Ÿæ˜¯ `MADispatchQueue` æ‰€éœ€è¦çš„æœ€åä¸€ä¸ª API ã€‚

### ç»“è®º

å¯ä»¥é€šè¿‡ä¸€ä¸ªä¿å­˜ä»£ç å—çš„é˜Ÿåˆ—å’ŒåŠ¨æ€åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹çš„æ–¹æ³•æ¥å®ç°ä¸€ä¸ªå…¨å±€çš„çº¿ç¨‹æ± ã€‚é€šè¿‡ä½¿ç”¨ä¸€ä¸ªå…±äº«çš„å…¨å±€çº¿ç¨‹æ± ï¼Œå¯ä»¥æ„å»ºåŸºæœ¬çš„ `Dispatch Queue` APIï¼Œæ”¯æŒä¸²è¡Œ/å¹¶è¡ŒåŠåŒæ­¥/å¼‚æ­¥æ´¾å‘ä»»åŠ¡ã€‚æœ¬æ–‡çš„å®ç°å°‘äº†è®¸å¤š GCD ä¸­å¾ˆèµçš„åŠŸèƒ½ï¼Œè€Œä¸”ä¹Ÿç¡®å®æ¯” GCD ä½æ•ˆå¾—å¤šã€‚ä½†å³ä¾¿å¦‚æ­¤ï¼Œæœ¬æ–‡è¿˜æ˜¯å¯ä»¥è®©ä½ çª¥è§†åˆ° GCD å†…éƒ¨çš„è¿ä½œåŸç†ï¼Œè®©ä½ æ˜ç™½è¿™å…¶å®ä¹Ÿä¸æ˜¯ä»€ä¹ˆç¥å¥‡çš„äº‹ã€‚ï¼ˆé™¤äº† `dispatch_once`ï¼Œç€ç®€ç›´å°±æ˜¯ä¸ªé­”æ³•ã€‚ï¼‰

è¿™å°±æ˜¯ä»Šå¤©æ‰€æœ‰çš„å†…å®¹äº†ï¼Œè®°å¾—ä¸è¦é”™è¿‡ä¸‹ä¸€æ¬¡æ›´å¤šæœ‰è¶£çš„å†…å®¹å“¦ã€‚å¦å¤–ï¼Œå‘¨äº”çš„ Q&A æ˜¯ç”±è¯»è€…é©±åŠ¨çš„ï¼Œæ‰€ä»¥å¦‚æœä½ æœ‰ä»€ä¹ˆæƒ³åœ¨è¿™é‡Œè®¨è®ºçš„ï¼Œç»™æˆ‘[å‘ä¸ªé‚®ä»¶](mailto:mike@mikeash.com)å§ï¼
> æœ¬æ–‡ç”± SwiftGG ç¿»è¯‘ç»„ç¿»è¯‘ï¼Œå·²ç»è·å¾—ä½œè€…ç¿»è¯‘æˆæƒï¼Œæœ€æ–°æ–‡ç« è¯·è®¿é—® [http://swift.gg](http://swift.gg)ã€‚„é˜Ÿåˆ—æ¥å®ç°ã€‚ä½¿ç”¨ä¸€ä¸ªå…±äº«çš„çº¿ç¨‹æ± ï¼Œä¸€ä¸ªåŸºæœ¬çš„è°ƒåº¦é˜Ÿåˆ—çš„ API å°±å¯ä»¥è¢«åˆ›å»ºï¼Œå®ƒæä¾›äº†åŸºæœ¬çš„ä¸²è¡Œ/å¹¶è¡Œé˜Ÿåˆ—ä¸‹åŒæ­¥/å¼‚æ­¥ä»»åŠ¡çš„è°ƒåº¦ã€‚è¿™æ¬¡çš„é‡æ–°å®ç°ç¼ºå°‘äº† GCD ä¸­è®¸å¤šä¼˜ç§€çš„ç‰¹å¾ï¼Œå¹¶ä¸”è‚¯å®šæ²¡æœ‰ GCD é‚£ä¹ˆé«˜æ•ˆï¼Œä½†å³ä¾¿å¦‚æ­¤å®ƒè®©æˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ°åƒè¿™æ ·ä¸€ç§æœºåˆ¶çš„å†…éƒ¨åŸç†æ˜¯æ€æ ·çš„ï¼Œå¹¶ä¸”è®©æˆ‘ä»¬çœ‹åˆ°é‚£å¹¶ä¸æ˜¯ä»€ä¹ˆé­”æ³•ï¼ˆé™¤äº†`dispatch_once`ï¼Œé‚£æ˜¯ç»å¯¹çš„é­”æ³•ï¼ï¼‰ã€‚

è¿™å°±æ˜¯ä»Šå¤©çš„å†…å®¹ã€‚ä¸‹æ¬¡å›æ¥çœ‹æ›´å¤šæœ‰è¶£çš„å†…å®¹ã€‚"Friday Q&A"æ˜¯ç”±ç”¨æˆ·çš„æƒ³æ³•é©±åŠ¨çš„ï¼Œæ‰€ä»¥å¦‚æœä½ å¸Œæœ›ä¸‹æ¬¡æˆ–è€…å°†æ¥æˆ‘å¯ä»¥åœ¨è¿™é‡Œè®¨è®ºæŸäº›å†…å®¹ï¼Œè¯·[å‘Šè¯‰æˆ‘](mailto:mike@mikeash.com)ï¼





> æœ¬æ–‡ç”± SwiftGG ç¿»è¯‘ç»„ç¿»è¯‘ï¼Œå·²ç»è·å¾—ä½œè€…ç¿»è¯‘æˆæƒï¼Œæœ€æ–°æ–‡ç« è¯·è®¿é—® [http://swift.gg](http://swift.gg)ã€‚