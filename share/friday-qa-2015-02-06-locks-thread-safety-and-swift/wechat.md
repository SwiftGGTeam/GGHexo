Swift ä¸­çš„é”å’Œçº¿ç¨‹å®‰å…¨"

> ä½œè€…ï¼šMike Ashï¼Œ[åŸæ–‡é“¾æ¥](https://www.mikeash.com/pyblog/friday-qa-2015-02-06-locks-thread-safety-and-swift.html)ï¼ŒåŸæ–‡æ—¥æœŸï¼š2015-02-06
> è¯‘è€…ï¼šLefe_xï¼›æ ¡å¯¹ï¼š[numbbbbb](http://numbbbbb.com/)ï¼Œ[Yousanflics](http://blog.yousanflics.com.cn)ï¼Œ[liberalism](https://weibo.com/1743643682/profile?topnav=1&wvr=6)ï¼›å®šç¨¿ï¼š[CMB](https://github.com/chenmingbiao)
  









åœ¨ Swift ä¸­æœ‰ä¸ªæœ‰è¶£çš„ç°è±¡ï¼šå®ƒæ²¡æœ‰ä¸çº¿ç¨‹ç›¸å…³çš„è¯­æ³•ï¼Œä¹Ÿæ²¡æœ‰æ˜ç¡®çš„äº’æ–¥é”/é”ï¼ˆ`mutexes/locks`ï¼‰æ¦‚å¿µï¼Œç”šè‡³ Objective-C ä¸­æœ‰çš„ `@synchronized` å’ŒåŸå­å±æ€§å®ƒéƒ½æ²¡æœ‰ã€‚å¹¸è¿çš„æ˜¯ï¼Œè‹¹æœç³»ç»Ÿçš„ API å¯ä»¥éå¸¸å®¹æ˜“åœ°åº”ç”¨åˆ° Swift ä¸­ã€‚ä»Šå¤©ï¼Œæˆ‘ä¼šä»‹ç»è¿™äº› API çš„ç”¨æ³•ä»¥åŠä» Objective-C è¿‡æ¸¡çš„ä¸€äº›é—®é¢˜ï¼Œè¿™äº›çµæ„Ÿéƒ½æ¥æºäº Cameron Pulsfordã€‚



## å¿«é€Ÿå›é¡¾ä¸€ä¸‹é”

é”ï¼ˆ`lock`ï¼‰æˆ–è€…äº’æ–¥é”ï¼ˆ`mutex`ï¼‰æ˜¯ä¸€ç§ç»“æ„ï¼Œç”¨æ¥ä¿è¯ä¸€æ®µä»£ç åœ¨åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚å®ƒä»¬é€šå¸¸è¢«ç”¨æ¥ä¿è¯å¤šçº¿ç¨‹è®¿é—®åŒä¸€å¯å˜æ•°æ®ç»“æ„æ—¶çš„æ•°æ®ä¸€è‡´æ€§ã€‚ä¸»è¦æœ‰ä¸‹é¢å‡ ç§é”ï¼š

- é˜»å¡é”ï¼ˆ`Blocking locks`ï¼‰ï¼šå¸¸è§çš„è¡¨ç°å½¢å¼æ˜¯å½“å‰çº¿ç¨‹ä¼šè¿›å…¥ä¼‘çœ ï¼Œç›´åˆ°è¢«å…¶ä»–çº¿ç¨‹é‡Šæ”¾ã€‚
- è‡ªæ—‹é”ï¼ˆ`Spinlocks`ï¼‰ï¼šä½¿ç”¨ä¸€ä¸ªå¾ªç¯ä¸æ–­åœ°æ£€æŸ¥é”æ˜¯å¦è¢«é‡Šæ”¾ã€‚å¦‚æœç­‰å¾…æƒ…å†µå¾ˆå°‘è¯è¿™ç§é”æ˜¯éå¸¸é«˜æ•ˆçš„ï¼Œç›¸åï¼Œç­‰å¾…æƒ…å†µéå¸¸å¤šçš„æƒ…å†µä¸‹ä¼šæµªè´¹ CPU æ—¶é—´ã€‚
- è¯»å†™é”ï¼ˆ`Reader/writer locks`ï¼‰ï¼šå…è®¸å¤šä¸ªè¯»çº¿ç¨‹åŒæ—¶è¿›å…¥ä¸€æ®µä»£ç ï¼Œä½†å½“å†™çº¿ç¨‹è·å–é”æ—¶ï¼Œå…¶ä»–çº¿ç¨‹ï¼ˆåŒ…æ‹¬è¯»å–å™¨ï¼‰åªèƒ½ç­‰å¾…ã€‚è¿™æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œå› ä¸ºå¤§å¤šæ•°æ•°æ®ç»“æ„è¯»å–æ—¶æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†å½“å…¶ä»–çº¿ç¨‹è¾¹è¯»è¾¹å†™æ—¶å°±ä¸å®‰å…¨äº†ã€‚
- é€’å½’é”ï¼ˆ`Recursive locks`ï¼‰ï¼šå…è®¸å•ä¸ªçº¿ç¨‹å¤šæ¬¡è·å–ç›¸åŒçš„é”ã€‚éé€’å½’é”è¢«åŒä¸€çº¿ç¨‹é‡å¤è·å–æ—¶å¯èƒ½ä¼šå¯¼è‡´æ­»é”ã€å´©æºƒæˆ–å…¶ä»–é”™è¯¯è¡Œä¸ºã€‚

## APIs

è‹¹æœæä¾›äº†ä¸€ç³»åˆ—ä¸åŒçš„é” APIï¼Œä¸‹é¢åˆ—å‡ºäº†å…¶ä¸­ä¸€äº›ï¼š 

- `pthread_mutex_t`
- `pthread_rwlock_t`
- `dispatch_queue_t`
- `NSOperationQueue` å½“é…ç½®ä¸º `serial` æ—¶
- `NSLock`
- `OSSpinLock`

é™¤æ­¤ä¹‹å¤–ï¼ŒObjective-C æä¾›äº† `@synchronized` è¯­æ³•ç»“æ„ï¼Œå®ƒå…¶å®å°±æ˜¯å°è£…äº† `pthread_mutex_t` ã€‚ä¸å…¶ä»– API ä¸åŒçš„æ˜¯ï¼Œ`@synchronized` å¹¶æœªä½¿ç”¨ä¸“é—¨çš„é”å¯¹è±¡ï¼Œå®ƒå¯ä»¥å°†ä»»æ„ Objective-C å¯¹è±¡è§†ä¸ºé”ã€‚`@synchronized(someObject)` åŒºåŸŸä¼šé˜»æ­¢å…¶ä»– `@synchronized(someObject)` åŒºåŸŸè®¿é—®åŒä¸€å¯¹è±¡æŒ‡é’ˆã€‚ä¸åŒçš„ API æœ‰ä¸åŒçš„è¡Œä¸ºå’Œèƒ½åŠ›ï¼š 

- `pthread_mutex_t` æ˜¯ä¸€ä¸ªå¯é€‰æ‹©æ€§åœ°é…ç½®ä¸ºé€’å½’é”çš„é˜»å¡é”ï¼›
- `pthread_rwlock_t` æ˜¯ä¸€ä¸ªé˜»å¡è¯»å†™é”ï¼›
- `dispatch_queue_t` å¯ä»¥ç”¨ä½œé˜»å¡é”ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä½¿ç”¨ barrier block é…ç½®ä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—ä½œä¸ºè¯»å†™é”ï¼Œè¿˜æ”¯æŒå¼‚æ­¥æ‰§è¡ŒåŠ é”ä»£ç ï¼›
- `NSOperationQueue` å¯ä»¥ç”¨ä½œé˜»å¡é”ã€‚ä¸ `dispatch_queue_t` ä¸€æ ·ï¼Œæ”¯æŒå¼‚æ­¥æ‰§è¡ŒåŠ é”ä»£ç ã€‚
- `NSLock` æ˜¯ Objective-C ç±»çš„é˜»å¡é”ï¼Œå®ƒçš„åŒä¼´ç±» `NSRecursiveLock` æ˜¯é€’å½’é”ã€‚
- `OSSpinLock` é¡¾åæ€ä¹‰ï¼Œæ˜¯ä¸€ä¸ªè‡ªæ—‹é”ã€‚

æœ€åï¼Œ`@synchronized` æ˜¯ä¸€ä¸ªé˜»å¡é€’å½’é”ã€‚

### å€¼ç±»å‹

æ³¨æ„ï¼Œ`pthread_mutex_t`ï¼Œ`pthread_rwlock_t` å’Œ `OSSpinLock` æ˜¯å€¼ç±»å‹ï¼Œè€Œä¸æ˜¯å¼•ç”¨ç±»å‹ã€‚è¿™æ„å‘³ç€å¦‚æœä½ ç”¨ `=` è¿›è¡Œèµ‹å€¼æ“ä½œï¼Œå®é™…ä¸Šä¼šå¤åˆ¶ä¸€ä¸ªå‰¯æœ¬ã€‚è¿™ä¼šé€ æˆä¸¥é‡çš„åæœï¼Œå› ä¸ºè¿™äº›ç±»å‹æ— æ³•å¤åˆ¶ï¼å¦‚æœä½ ä¸å°å¿ƒå¤åˆ¶äº†å®ƒä»¬ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œè¿™ä¸ªå‰¯æœ¬æ— æ³•ä½¿ç”¨ï¼Œå¦‚æœä½¿ç”¨å¯èƒ½ä¼šç›´æ¥å´©æºƒã€‚è¿™äº›ç±»å‹çš„ `pthread` å‡½æ•°ä¼šå‡å®šå®ƒä»¬çš„å†…å­˜åœ°å€ä¸åˆå§‹åŒ–æ—¶ä¸€æ ·ï¼Œå› æ­¤å¦‚æœå°†å®ƒä»¬ç§»åŠ¨åˆ°å…¶ä»–åœ°æ–¹å°±å¯èƒ½ä¼šå‡ºé—®é¢˜ã€‚`OSSpinLock ` ä¸ä¼šå´©æºƒï¼Œä½†å¤åˆ¶æ“ä½œä¼šç”Ÿæˆä¸€ä¸ªå®Œå…¨ç‹¬ç«‹çš„é”ï¼Œè¿™ä¸æ˜¯ä½ æƒ³è¦çš„ã€‚

å¦‚æœä½¿ç”¨è¿™äº›ç±»å‹ï¼Œå°±å¿…é¡»æ³¨æ„ä¸è¦å»å¤åˆ¶å®ƒä»¬ï¼Œæ— è®ºæ˜¯æ˜¾å¼çš„ä½¿ç”¨ `=` æ“ä½œç¬¦è¿˜æ˜¯éšå¼åœ°æ“ä½œã€‚
ä¾‹å¦‚ï¼Œå°†å®ƒä»¬åµŒå…¥åˆ°ç»“æ„ä¸­æˆ–åœ¨é—­åŒ…ä¸­æ•è·å®ƒä»¬ã€‚

å¦å¤–ï¼Œç”±äºé”æœ¬è´¨ä¸Šæ˜¯å¯å˜å¯¹è±¡ï¼Œéœ€è¦ç”¨ `var` æ¥å£°æ˜å®ƒä»¬ã€‚

å…¶ä»–é”éƒ½æ˜¯æ˜¯å¼•ç”¨ç±»å‹ï¼Œå®ƒä»¬å¯ä»¥éšæ„ä¼ é€’ï¼Œå¹¶ä¸”å¯ä»¥ç”¨ `let` å£°æ˜ã€‚ 

### åˆå§‹åŒ–

2015-02-10 æ›´æ–°ï¼šæœ¬èŠ‚ä¸­æ‰€æè¿°çš„é—®é¢˜å·²ç»ä»¥æƒŠäººçš„é€Ÿåº¦è¢«æ·˜æ±°ã€‚è‹¹æœæ˜¨å¤©å‘å¸ƒäº† Xcode 6.3 beta 1ï¼Œå…¶ä¸­åŒ…æ‹¬ Swift 1.2ã€‚åœ¨å…¶ä»–æ›´æ”¹ä¸­ï¼Œç°åœ¨ä½¿ç”¨ä¸€ä¸ªç©ºçš„åˆå§‹åŒ–å™¨å¯¼å…¥ C ç»“æ„ï¼Œå°†æ‰€æœ‰å­—æ®µè®¾ç½®ä¸ºé›¶ã€‚ç®€è€Œè¨€ä¹‹ï¼Œä½ ç°åœ¨å¯ä»¥ç›´æ¥ä½¿ç”¨ `pthread_mutex_t()`ï¼Œä¸éœ€è¦ä¸‹é¢æåˆ°çš„æ‰©å±•ã€‚

pthread ç±»å‹å¾ˆéš¾åœ¨ swift ä¸­ä½¿ç”¨ã€‚å®ƒä»¬è¢«å®šä¹‰ä¸ºä¸é€æ˜çš„ç»“æ„ä½“ä¸­åŒ…å«äº†ä¸€å †å­˜å‚¨å˜é‡ï¼Œä¾‹å¦‚ï¼š

    
    struct _opaque_pthread_mutex_t {
        long __sig;
        char __opaque[__PTHREAD_MUTEX_SIZE__];
    };

ç›®çš„æ˜¯å£°æ˜å®ƒä»¬ï¼Œç„¶åä½¿ç”¨ init å‡½æ•°å¯¹å®ƒä»¬è¿›è¡Œåˆå§‹åŒ–ï¼Œä½¿ç”¨ä¸€ä¸ªæŒ‡é’ˆå­˜å‚¨å’Œå¡«å……ã€‚åœ¨ C ä¸­ï¼Œå®ƒçœ‹èµ·æ¥åƒï¼š 

    c
    pthread_mutex_t mutex;
    pthread_mutex_init(&mutex, NULL);

è¿™æ®µä»£ç å¯ä»¥æ­£å¸¸çš„å·¥ä½œï¼Œåªè¦ä½ è®°å¾—è°ƒç”¨ `pthread_mutex_init`ã€‚ç„¶è€Œï¼ŒSwift çœŸçš„çœŸçš„ä¸å–œæ¬¢æœªåˆå§‹åŒ–çš„å˜é‡ã€‚ä¸ä¸Šé¢ä»£ç ç­‰æ•ˆçš„ Swift ç‰ˆæœ¬æ— æ³•ç¼–è¯‘ï¼š 

    
    var mutex: pthread_mutex_t
    pthread_mutex_init(&mutex, nil)
    // error: address of variable 'mutex' taken before it is initialized

Swift éœ€è¦å˜é‡åœ¨ä½¿ç”¨å‰åˆå§‹åŒ–ã€‚`pthread_mutex_init` ä¸ä½¿ç”¨ä¼ å…¥çš„å˜é‡çš„å€¼ï¼Œåªæ˜¯é‡å†™å®ƒï¼Œä½†æ˜¯ Swift ä¸çŸ¥é“ï¼Œå› æ­¤å®ƒäº§ç”Ÿäº†ä¸€ä¸ªé”™è¯¯ã€‚ä¸ºäº†æ»¡è¶³ç¼–è¯‘å™¨ï¼Œå˜é‡éœ€è¦ç”¨æŸç§ä¸œè¥¿åˆå§‹åŒ–ã€‚åœ¨ç±»å‹ä¹‹åä½¿ç”¨ `()`ï¼Œä½†è¿™æ ·å†™ä»ç„¶ä¼šæŠ¥é”™ï¼š

    
    var mutex = pthread_mutex_t()
    // error: missing argument for parameter '__sig' in call

Swift éœ€è¦é‚£äº›ä¸é€æ˜å­—æ®µçš„å€¼ã€‚`__sig` å¯ä»¥ä¼ å…¥é›¶ï¼Œä½†æ˜¯ `__opaque` å°±æœ‰ç‚¹çƒ¦äººäº†ã€‚ä¸‹é¢çš„ç»“æ„ä½“éœ€è¦æ¡¥æ¥åˆ° swift ä¸­ï¼š

    
    struct _opaque_pthread_mutex_t {
       var __sig: Int
       var __opaque: (Int8, Int8, Int8, Int8,
                   Int8, Int8, Int8, Int8,
                   Int8, Int8, Int8, Int8,
                   Int8, Int8, Int8, Int8,
                   Int8, Int8, Int8, Int8,
                   Int8, Int8, Int8, Int8,
                   Int8, Int8, Int8, Int8,
                   Int8, Int8, Int8, Int8,
                   Int8, Int8, Int8, Int8,
                   Int8, Int8, Int8, Int8,
                   Int8, Int8, Int8, Int8,
                   Int8, Int8, Int8, Int8,
                   Int8, Int8, Int8, Int8,
                   Int8, Int8, Int8, Int8)
    }

ç›®å‰æ²¡æœ‰ç®€å•çš„æ–¹æ³•ä½¿ç”¨ä¸€å † 0 æ„å»ºä¸€ä¸ªå…ƒç»„ï¼Œåªèƒ½åƒä¸‹é¢è¿™æ ·æŠŠæ‰€æœ‰çš„ 0 éƒ½å†™å‡ºæ¥ï¼š

    
    var mutex = pthread_mutex_t(__sig: 0,
                                 __opaque: (0, 0, 0, 0, 0, 0, 0, 0,
                                            0, 0, 0, 0, 0, 0, 0, 0,
                                            0, 0, 0, 0, 0, 0, 0, 0,
                                            0, 0, 0, 0, 0, 0, 0, 0,
                                            0, 0, 0, 0, 0, 0, 0, 0,
                                            0, 0, 0, 0, 0, 0, 0, 0,
                                            0, 0, 0, 0, 0, 0, 0, 0))

è¿™ä¹ˆå†™å¤ªéš¾çœ‹äº†ï¼Œä½†æˆ‘æ²¡æ‰¾åˆ°å¥½çš„æ–¹æ³•ã€‚æˆ‘èƒ½æƒ³åˆ°æœ€å¥½çš„åšæ³•å°±æ˜¯æŠŠå®ƒå†™åˆ°ä¸€ä¸ªæ‰©å±•ä¸­ï¼Œè¿™æ ·ç›´æ¥ä½¿ç”¨ç©ºçš„ `()` å°±å¯ä»¥äº†ã€‚ä¸‹é¢æ˜¯æˆ‘å†™çš„ä¸¤ä¸ªæ‰©å±•ï¼š 

    
        extension pthread_mutex_t {
            init() {
                __sig = 0
                __opaque = (0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0)
            }
        }
    
        extension pthread_rwlock_t {
            init() {
                __sig = 0
                __opaque = (0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0,
                            0, 0, 0, 0, 0, 0, 0, 0)
            }
        }

å¯ä»¥é€šè¿‡ä¸‹é¢è¿™ç§æ–¹å¼ä½¿ç”¨ï¼š

    
    var mutex = pthread_mutex_t()
    pthread_mutex_init(&mutex, nil)

## é”çš„å°è£…

ä¸ºäº†ä½¿è¿™äº›ä¸åŒçš„ API æ›´æ˜“äºä½¿ç”¨ï¼Œæˆ‘ç¼–å†™äº†ä¸€ç³»åˆ—å°å‹å‡½æ•°ã€‚æˆ‘å†³å®šæŠŠ `with` ä½œä¸ºä¸€ä¸ªæ–¹ä¾¿ã€ç®€çŸ­ã€çœ‹èµ·æ¥åƒè¯­æ³•çš„åå­—ï¼Œçµæ„Ÿæ¥è‡ª python çš„ `with` å£°æ˜ã€‚Swift å‡½æ•°é‡è½½å…è®¸ä¸åŒç±»å‹ä½¿ç”¨ç›¸åŒçš„åç§°ã€‚åŸºæœ¬å½¢å¼å¦‚ä¸‹æ‰€ç¤ºï¼š

    
    func with(lock: SomeLockType, f: Void -> Void) { ...

ç„¶ååœ¨é”å®šçš„æƒ…å†µä¸‹æ‰§è¡Œå‡½æ•° fã€‚ä¸‹é¢æˆ‘ä»¬æ¥å®ç°è¿™äº›ç±»å‹ã€‚

å¯¹äºå€¼ç±»å‹ï¼Œå®ƒéœ€è¦ä¸€ä¸ªæŒ‡å‘é”çš„æŒ‡é’ˆï¼Œä»¥ä¾¿ lock/unlock å‡½æ•°å¯ä»¥ä¿®æ”¹å®ƒã€‚è¿™ä¸ªå®ç°`pthread_mutex_t` åªæ˜¯è°ƒç”¨ç›¸åº”çš„ lock å’Œ unlock å‡½æ•°ï¼Œf å‡½æ•°åœ¨ä¸¤è€…ä¹‹é—´è°ƒç”¨ï¼š

    
    func with(mutex: UnsafeMutablePointer<pthread_mutex_t>, f: Void -> Void) {
        pthread_mutex_lock(mutex)
        f()
        pthread_mutex_unlock(mutex)
    }

`pthread_rwlock_t` çš„å®ç°å‡ ä¹å®Œå…¨ç›¸åŒï¼š

    
    func with(rwlock: UnsafeMutablePointer<pthread_rwlock_t>, f: Void -> Void) {
        pthread_rwlock_rdlock(rwlock)
        f()
        pthread_rwlock_unlock(rwlock)
    }

ä¸è¯»å†™é”åšä¸ªå¯¹æ¯”ï¼Œå®ƒä»¬çœ‹èµ·æ¥å¾ˆåƒï¼š

    
    func with_write(rwlock: UnsafeMutablePointer<pthread_rwlock_t>, f: Void -> Void) {
        pthread_rwlock_wrlock(rwlock)
        f()
        pthread_rwlock_unlock(rwlock)
    }

`dispatch_queue_t` æ›´ç®€å•ã€‚å®ƒåªéœ€è¦å°è£… `dispatch_syncï¼š`ï¼š

    
    func with(queue: dispatch_queue_t, f: Void -> Void) {
        dispatch_sync(queue, f)
    }

å¦‚æœä¸€ä¸ªäººæƒ³æ˜¾æ‘†è‡ªå·±å¾ˆèªæ˜ï¼Œé‚£ä¹ˆå¯ä»¥å……åˆ†åˆ©ç”¨ Swift çš„å‡½æ•°å¼ç‰¹æ€§ç®€å•çš„å†™å‡ºè¿™æ ·çš„ä»£ç ï¼š

`let with = dispatch_sync`

è¿™ç§å†™æ³•å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œæœ€å¤§çš„é—®é¢˜æ˜¯å®ƒä¼šå’Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„åŸºäºç±»å‹çš„é‡è½½æ··æ·†ã€‚

`NSOperationQueue` åœ¨æ¦‚å¿µä¸Šæ˜¯ç›¸ä¼¼çš„ï¼Œä¸è¿‡æ²¡æœ‰ `dispatch_sync` å¯ä»¥ç”¨ã€‚æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ“ä½œï¼ˆ`operation`ï¼‰ï¼Œå°†å…¶æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œå¹¶æ˜¾å¼ç­‰å¾…å®ƒå®Œæˆï¼š

    
    func with(opQ: NSOperationQueue, f: Void -> Void) {
        let op = NSBlockOperation(f)
        opQ.addOperation(op)
        op.waitUntilFinished()
    }

å®ç° `NSLock` çœ‹èµ·æ¥åƒ `pthread` ç‰ˆæœ¬ï¼Œåªæ˜¯é”å®šè°ƒç”¨æœ‰äº›ä¸åŒï¼š

    
    func with(lock: NSLock, f: Void -> Void) {
        lock.lock()
        f()
        lock.unlock()
    }

æœ€åï¼Œ`OSSpinLock` çš„å®ç°åŒæ ·ä¹Ÿæ˜¯å¦‚æ­¤ï¼š

    
    func with(spinlock: UnsafeMutablePointer<OSSpinLock>, f: Void -> Void) {
        OSSpinLockLock(spinlock)
        f()
        OSSpinLockUnlock(spinlock)
    }

### æ¨¡ä»¿ `@synchronized`

æœ‰äº†ä¸Šé¢çš„å°è£…ï¼Œæ¨¡ä»¿ `@synchronized` çš„å®ç°å°±å˜å¾—å¾ˆç®€å•ã€‚ç»™ä½ çš„ç±»æ·»åŠ ä¸€ä¸ªå±æ€§ï¼ŒæŒæœ‰ä¸€ä¸ªé”ï¼Œç„¶åä½¿ç”¨ `with` æ›¿ä»£ `@synchronized` ï¼š

    
    let queue = dispatch_queue_create("com.example.myqueue", nil)
    
    func setEntryForKey(key: Key, entry: Entry) {
        with(queue) {
            entries[key] = entry
        }
    }

ä» block ä¸­è·å–æ•°æ®æ¯”è¾ƒéº»çƒ¦ã€‚`@synchronized` å¯ä»¥ä»å†…éƒ¨ `return` ï¼Œä½†æ˜¯ `with` åšä¸åˆ°ã€‚ä½ å¿…é¡»ä½¿ç”¨ä¸€ä¸ª `var` å˜é‡åœ¨ block å†…éƒ¨èµ‹å€¼ç»™å®ƒï¼š

    
    func entryForKey(key: Key) -> Entry? {
        var result: Entry?
        with(queue) {
            result = entries[key]
        }
        return result
    }

æŒ‰ç†è¯´å¯ä»¥å°†è¿™æ®µä»£ç å½“åšæ¨¡æ¿å°è£…åœ¨ä¸€ä¸ªé€šç”¨å‡½æ•°ä¸­ï¼Œä½†æ˜¯å®ƒæ— æ³•é€šè¿‡ Swift ç¼–è¯‘å™¨çš„ç±»å‹æ¨æ–­ï¼Œç›®å‰è¿˜æ²¡æœ‰æ‰¾åˆ°è§£å†³æ–¹æ³•ã€‚

### æ¨¡æ‹ŸåŸå­å±æ€§

åŸå­å±æ€§ï¼ˆ`atomic`ï¼‰å¹¶ä¸å¸¸ç”¨ã€‚ä¸å…¶ä»–ä»£ç å±æ€§ä¸åŒï¼ŒåŸå­å±æ€§å¹¶ä¸æ”¯æŒç»„åˆç‡ã€‚å¦‚æœå‡½æ•° f ä¸å­˜åœ¨å†…å­˜æ³„æ¼ï¼Œå‡½æ•° g ä¸å­˜åœ¨å†…å­˜æ³„æ¼ï¼Œé‚£ä¹ˆå‡½æ•° h åªæ˜¯è°ƒç”¨ f å’Œ g ä¹Ÿä¸ä¼šå­˜åœ¨å†…å­˜æ³„æ¼ã€‚ä½†æ˜¯åŸå­å±æ€§å¹¶ä¸æ»¡è¶³è¿™ä¸ªæ¡ä»¶ã€‚ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå‡è®¾ä½ æœ‰ä¸€ä¸ªå®šä¹‰æˆåŸå­å±æ€§å¹¶ä¸”çº¿ç¨‹å®‰å…¨çš„ Account ç±»ï¼š

    
    let checkingAccount = Account(amount: 100)
    let savingsAccount = Account(amount: 0)

ç°åœ¨è¦æŠŠé’±è½¬åˆ°å‚¨è“„è´¦æˆ·ä¸­ï¼š

    
    checkingAccount.withDraw(100)
    savingsAccount.deposit(100)

åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œç»Ÿè®¡å¹¶æ˜¾ç¤ºä½™é¢ï¼š

    
    println("Your total balance is: \(checkingAccount.amount + savingsAccount.amount)")

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè¿™æ®µä»£ç ä¼šæ‰“å° 0ï¼Œè€Œä¸æ˜¯ 100ï¼Œå°½ç®¡äº‹å®ä¸Šè¿™äº› Account å¯¹è±¡æœ¬èº«æ˜¯åŸå­å±æ€§ï¼Œå¹¶ä¸”ç”¨æˆ·ç¡®å®æœ‰ 100 çš„ä½™é¢ã€‚æ‰€ä»¥ï¼Œæœ€å¥½è®©æ•´ä¸ªå­ç³»ç»Ÿéƒ½æ»¡è¶³åŸå­æ€§ï¼Œè€Œä¸æ˜¯å•ä¸ªå±æ€§ã€‚

åœ¨æå°‘æ•°æƒ…å†µä¸‹ï¼ŒåŸå­å±æ€§æ˜¯æœ‰ç”¨çš„ï¼Œå› ä¸ºå®ƒå¹¶ä¸ä¾èµ–å…¶ä»–ç‰¹æ€§ï¼Œåªéœ€è¦çº¿ç¨‹å®‰å…¨å³å¯ã€‚è¦åœ¨ Swift ä¸­å®ç°è¿™ä¸€ç‚¹ï¼Œéœ€è¦ä¸€ä¸ªè®¡ç®—å±æ€§æ¥å®Œæˆé”å®šï¼Œç”¨å¦ä¸€ä¸ªå¸¸è§„å±æ€§ä¿å­˜å€¼ï¼š

    
    private let queue = dispatch_queue_create("...", nil)
    private var _myPropertyStorage: SomeType
    
    var myProperty: SomeType {
        get {
            var result: SomeType?
            with(queue) {
                result = _myPropertyStorage
            }
            return result!
        }
        set {
            with(queue) {
                _myPropertyStorage = newValue
            }
        }
    }

### å¦‚ä½•é€‰æ‹©é” API

`pthread` API åœ¨ Swift ä¸­ä¸å¤ªå¥½ç”¨ï¼Œè€Œä¸”åŠŸèƒ½å¹¶ä¸æ¯”å…¶å®ƒ API å¤šã€‚ä¸€èˆ¬æˆ‘æ¯”è¾ƒå–œæ¬¢åœ¨ C å’Œ Objective-C ä¸­ä½¿ç”¨å®ƒä»¬ï¼Œå› ä¸ºå®ƒä»¬åˆå¥½ç”¨åˆé«˜æ•ˆã€‚ä½†æ˜¯åœ¨ Swift ä¸­ï¼Œé™¤éå¿…è¦ï¼Œæˆ‘ä¸€èˆ¬ä¸ä¼šç”¨ã€‚

ä¸€èˆ¬æ¥è¯´ä¸éœ€è¦ç”¨è¯»å†™é”ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹è¯»å†™é€Ÿåº¦éƒ½éå¸¸å¿«ã€‚è¯»å†™é”å¸¦æ¥çš„é¢å¤–å¼€é”€è¶…è¿‡äº†å¹¶å‘è¯»å–å¸¦æ¥çš„æ•ˆç‡æå‡ã€‚

é€’å½’é”ä¼šå‘ç”Ÿæ­»é”ã€‚å¤šæ•°æƒ…å†µä¸‹å®ƒä»¬æ˜¯æœ‰ç”¨çš„ï¼Œä½†å¦‚æœä½ å‘ç°è‡ªå·±éœ€è¦è·å–ä¸€ä¸ªå·²ç»åœ¨å½“å‰çº¿ç¨‹è¢«é”ä½çš„é”ï¼Œé‚£æœ€å¥½é‡æ–°è®¾è®¡ä»£ç ï¼Œé€šå¸¸æ¥è¯´ä¸ä¼šå‡ºç°è¿™ç§éœ€æ±‚ã€‚

æˆ‘çš„å»ºè®®æ˜¯ï¼Œå¦‚æœä¸çŸ¥é“è¯¥ç”¨ä»€ä¹ˆï¼Œé‚£å°±é»˜è®¤é€‰æ‹© `dispatch_queue_t` ã€‚è™½ç„¶ç”¨èµ·æ¥ç›¸å¯¹éº»çƒ¦ï¼Œä½†æ˜¯ä¸ä¼šäº§ç”Ÿå¤ªå¤šé—®é¢˜ã€‚è¯¥ API éå¸¸æ–¹ä¾¿ï¼Œå¹¶ä¸”ç¡®ä¿ä½ æ°¸è¿œä¸ä¼šå¿˜è®°è°ƒç”¨ lock å’Œ unlockã€‚å®ƒæä¾›äº†è®¸å¤šæœ‰ç”¨çš„ APIï¼Œå¦‚ä½¿ç”¨å•ä¸ª `dispatch_async` åœ¨åå°æ‰§è¡Œè¢«é”å®šçš„ä»£ç ï¼Œæˆ–è€…è®¾ç½®å®šæ—¶å™¨æˆ–å…¶ä»–ä½œç”¨äº queue çš„äº‹ä»¶æºï¼Œä»¥ä¾¿å®ƒä»¬è‡ªåŠ¨æ‰§è¡Œé”å®šã€‚ä½ ç”šè‡³å¯ä»¥ç”¨å®ƒä½œä¸º `NSNotificationCenter` è§‚å¯Ÿè€…ï¼Œæˆ–è€…ä½¿ç”¨ `NSOperationQueue` çš„å±æ€§ `underlyingQueue` ä½œä¸º `NSURLSession` ä»£ç†ã€‚

`NSOperationQueue` å¯èƒ½è®¤ä¸ºè‡ªå·±å’Œ `dispatch_queue_t` ä¸€æ ·ç‰›ğŸ‘ƒï¼Œä½†æ˜¯å®é™…ä¸Šå¾ˆå°‘æœ‰åœºæ™¯éœ€è¦ä½¿ç”¨å®ƒã€‚è¿™ä¸ª API ä½¿ç”¨èµ·æ¥æ›´éº»çƒ¦ï¼Œè€Œä¸”å’Œå…¶ä»– API æ¯”æ²¡æœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Œæ— éåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå®ƒèƒ½è‡ªåŠ¨è¿›è¡Œæ“ä½œçš„ä¾èµ–å…³ç³»ç®¡ç†ï¼Œä¹Ÿå°±è¿™ç‚¹æ¯”è¾ƒæœ‰ç”¨ã€‚

`NSLock` æ˜¯ä¸€ä¸ªç®€å•çš„é”å®šç±»ï¼Œæ˜“äºä½¿ç”¨ä¸”æ•ˆç‡å¾ˆé«˜ã€‚å¦‚æœéœ€è¦æ˜¾å¼é”å®šå’Œè§£é”ï¼Œé‚£å¯ä»¥ç”¨å®ƒæ›¿ä»£ `dispatch_queue_t` ã€‚ä½†åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ä¸éœ€è¦ä½¿ç”¨å®ƒã€‚

`OSSpinLock` å¯¹äºç»å¸¸ä½¿ç”¨é”å®šã€ç«äº‰è¾ƒå°‘ä¸”é”å®šä»£ç è¿è¡Œé€Ÿåº¦å¿«çš„ç”¨æˆ·æ¥è¯´ï¼Œæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚å®ƒçš„å¼€é”€éå¸¸å°‘ï¼Œæœ‰åŠ©äºæå‡æ€§èƒ½ã€‚å¦‚æœä»£ç å¯èƒ½ä¼šåœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´å†…ä¿æŒé”å®šæˆ–ç«äº‰å¾ˆå¤šï¼Œé‚£æœ€å¥½ä¸è¦ç”¨è¿™ä¸ª APIï¼Œå› ä¸ºè¿™ä¼šæµªè´¹ CPU æ—¶é—´ã€‚é€šå¸¸æ¥è¯´ï¼Œä½ å¯ä»¥å…ˆä½¿ç”¨ `dispatch_queue_t` ï¼Œå¦‚æœè¿™å—å‡ºç°äº†æ€§èƒ½é—®é¢˜ï¼Œå†è€ƒè™‘æ¢æˆ `OSSpinLock` ã€‚

### æ€»ç»“

Swift è¯­è¨€å±‚é¢å¹¶ä¸æ”¯æŒçº¿ç¨‹åŒæ­¥ï¼Œä½†æ˜¯ Apple çš„ç³»ç»Ÿæ¡†æ¶æœ‰å¾ˆå¤šå¥½ç”¨çš„ APIã€‚`GCD` å’Œ `dispatch_queue_t` éå¸¸å¥½ç”¨ï¼Œå¹¶ä¸”Swift ä¸­çš„ API ä¹Ÿæ˜¯å¦‚æ­¤ã€‚è™½ç„¶ Swift é‡Œæ²¡æœ‰ `@synchronized` å’ŒåŸå­å±æ€§ï¼Œä½†æˆ‘ä»¬æœ‰å…¶ä»–æ›´å¥½çš„é€‰æ‹©ã€‚
> æœ¬æ–‡ç”± SwiftGG ç¿»è¯‘ç»„ç¿»è¯‘ï¼Œå·²ç»è·å¾—ä½œè€…ç¿»è¯‘æˆæƒï¼Œæœ€æ–°æ–‡ç« è¯·è®¿é—® [http://swift.gg](http://swift.gg)ã€‚